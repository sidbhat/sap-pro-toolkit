name: Security Audit & Quality Checks

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]

jobs:
  security-audit:
    runs-on: ubuntu-latest
    name: Security Scanning & Quality Checks
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ”’ Security Scan 1 - Credentials & Secrets
        run: |
          echo "ğŸ” Scanning for credentials and secrets..."
          if grep -r "password\|Password\|PASSWORD\|credential\|Credential\|secret\|Secret\|token\|Token\|apikey\|ApiKey\|API_KEY" \
            --include="*.json" --include="*.js" --include="*.html" . | \
            grep -v node_modules | grep -v ".git" | grep -v ".clinerules" | \
            grep -v "placeholder\|Placeholder\|PLACEHOLDER" | \
            grep -v "\.md:" | \
            grep -v "CUSTOMIZE"; then
            echo "âŒ FAIL: Found potential credentials"
            exit 1
          fi
          echo "âœ… PASS: No credentials found"
          
      - name: ğŸ”’ Security Scan 2 - Customer Data
        run: |
          echo "ğŸ” Scanning for customer-specific data..."
          if grep -r "SFSALES[0-9]\{6\}" --include="*.json" resources/ 2>/dev/null; then
            echo "âš ï¸ WARNING: Found SFSALES IDs (check if in .gitignore)"
            # Don't fail - just warn since these might be in .gitignore
          fi
          echo "âœ… PASS: Customer data check complete"
          
      - name: ğŸ”’ Security Scan 3 - Person IDs
        run: |
          echo "ğŸ” Scanning for person IDs..."
          if grep -r "I[0-9]\{13\}" --include="*.json" resources/ 2>/dev/null; then
            echo "âŒ FAIL: Found person IDs"
            exit 1
          fi
          echo "âœ… PASS: No person IDs found"
          
      - name: ğŸ”’ Security Scan 4 - Internal Emails
        run: |
          echo "ğŸ” Scanning for internal emails..."
          if grep -r "@.*\.corp\.sap\|@sap\.com" --include="*.json" resources/ 2>/dev/null; then
            echo "âŒ FAIL: Found internal SAP emails"
            exit 1
          fi
          echo "âœ… PASS: No internal emails found"
          
      - name: ğŸ”’ Security Scan 5 - API Keys (AI)
        run: |
          echo "ğŸ” Scanning for API keys..."
          if grep -r "sk-[a-zA-Z0-9]\{20,\}\|api_key.*=\|API_KEY.*=" \
            --include="*.js" --include="*.json" --include="*.env" . | \
            grep -v node_modules | grep -v ".git" | grep -v ".md:"; then
            echo "âŒ FAIL: Found API keys"
            exit 1
          fi
          echo "âœ… PASS: No API keys found"
          
      - name: ğŸ”’ Security Scan 6 - Hardcoded URL Parameters
        run: |
          echo "ğŸ” Scanning for hardcoded sensitive URL parameters..."
          if grep -r "password=\|token=\|key=\|secret=" \
            --include="*.js" --include="*.json" . | \
            grep -v node_modules | grep -v ".git" | grep -v "\.md:" | \
            grep -v "placeholder\|example\|CUSTOMIZE"; then
            echo "âŒ FAIL: Found hardcoded sensitive URL parameters"
            exit 1
          fi
          echo "âœ… PASS: No hardcoded URL parameters found"
          
      - name: ğŸ”’ Security Scan 7 - LLM Prompt Injection
        run: |
          echo "ğŸ” Scanning for LLM prompt injection patterns..."
          if grep -r "ignore previous\|forget instructions\|disregard\|new instructions" \
            --include="*.js" --include="*.json" . | \
            grep -v node_modules | grep -v ".git" | grep -v "\.md:"; then
            echo "âš ï¸ WARNING: Found potential prompt injection patterns"
            # Don't fail - just warn
          fi
          echo "âœ… PASS: Prompt injection check complete"
          
      - name: ğŸ”’ Security Scan 8 - Model Configuration
        run: |
          echo "ğŸ” Scanning for exposed model configurations..."
          # This is informational only - having model configs isn't necessarily bad
          grep -r "temperature\|max_tokens" --include="*.json" . | grep -v node_modules | grep -v ".git" || true
          echo "âœ… PASS: Model configuration check complete"
          
      - name: âœ… Security Summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ‰ ALL SECURITY SCANS PASSED"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "âœ… Credentials: No real passwords/tokens found"
          echo "âœ… Customer Data: Protected via .gitignore"
          echo "âœ… Person IDs: No production user IDs found"
          echo "âœ… Internal Emails: No @corp.sap emails found"
          echo "âœ… API Keys: No AI service keys found"
          echo "âœ… URL Params: No hardcoded sensitive parameters"
          echo "âœ… Prompt Injection: No injection patterns detected"
          echo "âœ… Model Config: Configuration exposure acceptable"
          echo ""
          echo "ğŸ”’ Repository is SAFE for public/private hosting"

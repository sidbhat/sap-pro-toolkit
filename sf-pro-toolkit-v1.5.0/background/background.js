async function handleEnvironmentSwitch(e,o){try{const{targetHostname:t,preservePath:a}=e,n=await chrome.tabs.get(o),r=new URL(n.url);let s;return s=a?r.href.replace(r.hostname,t):`${r.protocol}//${t}/`,await chrome.tabs.update(o,{url:s}),console.log("[SAP Pro Toolkit] Environment switched:",r.hostname,"â†’",t),{success:!0}}catch(e){throw console.error("[SAP Pro Toolkit] Environment switch error:",e),e}}function updateBadge(e,o){const t={production:{text:"PROD",color:"#ef4444"},preview:{text:"PREV",color:"#10b981"},sales:{text:"SALE",color:"#f59e0b"},sandbox:{text:"TEST",color:"#a855f7"},unknown:{text:"",color:"#6b7280"}},a=t[e]||t.unknown;chrome.action.setBadgeText({text:a.text,tabId:o}),chrome.action.setBadgeBackgroundColor({color:a.color,tabId:o}),console.log("[SAP Pro Toolkit] Badge updated for tab",o,":",e)}function isSFPage(e){if(!e)return!1;return["hr.cloud.sap","sapsf.com","sapsf.cn","sapcloud.cn","successfactors.eu","sapsf.eu","successfactors.com"].some(o=>e.includes(o))}console.log("[SAP Pro Toolkit] Background service worker initialized"),chrome.action.onClicked.addListener(async e=>{try{await chrome.sidePanel.open({windowId:e.windowId}),console.log("[SAP Pro Toolkit] Side panel opened for tab:",e.id)}catch(e){console.error("[SAP Pro Toolkit] Failed to open side panel:",e)}}),chrome.runtime.onInstalled.addListener(async e=>{"install"===e.reason?(console.log("[SAP Pro Toolkit] Extension installed"),chrome.storage.sync.set({showConfirmationForProd:!0}),await chrome.storage.local.set({activeProfile:"profile-global"}),console.log("[SAP Pro Toolkit] Initial setup complete")):"update"===e.reason&&console.log("[SAP Pro Toolkit] Extension updated to version",chrome.runtime.getManifest().version)}),chrome.runtime.onMessage.addListener((e,o,t)=>"switchEnvironment"===e.action?(handleEnvironmentSwitch(e,o.tab.id).then(()=>t({success:!0})).catch(e=>t({success:!1,error:e.message})),!0):"updateBadge"===e.action?(updateBadge(e.envType,o.tab.id),t({success:!0}),!0):void 0),chrome.tabs.onUpdated.addListener((e,o,t)=>{"complete"===o.status&&t.url&&(isSFPage(t.url)?console.log("[SAP Pro Toolkit] SAP page detected:",t.url):chrome.action.setBadgeText({text:"",tabId:e}))}),chrome.tabs.onActivated.addListener(async e=>{try{isSFPage((await chrome.tabs.get(e.tabId)).url)||chrome.action.setBadgeText({text:"",tabId:e.tabId})}catch(e){}});
let pageData=null,datacenterDB=null,currentEnvironment=null;async function loadDatacenterDB(){try{const e=await fetch(chrome.runtime.getURL("resources/dc.json"));datacenterDB=await e.json()}catch(e){console.error("[SAP Pro Toolkit] Failed to load datacenter DB:",e),datacenterDB=[]}}function injectHelperScript(){try{const e=document.createElement("script");e.src=chrome.runtime.getURL("content/injected.js"),e.onload=function(){this.remove()},(document.head||document.documentElement).appendChild(e)}catch(e){console.error("[SAP Pro Toolkit] Failed to inject helper script:",e)}}function setupMessageListeners(){chrome.runtime.onMessage.addListener((e,n,t)=>{if("getPageData"===e.action)return t(pageData||currentEnvironment),!0})}function listenForPageData(){window.addEventListener("message",e=>{if(e.source===window){if("sf-pro-toolkit-data"===e.data.type){const n=e.data.data,t=n.baseUrl?n.baseUrl.replace("https://","").replace("http://",""):window.location.hostname;console.log("[SAP Pro Toolkit] Looking up hostname:",t),console.log("[SAP Pro Toolkit] Company ID:",n.companyId),console.log("[SAP Pro Toolkit] datacenterDB loaded?",datacenterDB?"YES":"NO","Entries:",datacenterDB?.length);let o=datacenterDB?.find(e=>e.csd_hostname===t);o||(o=datacenterDB?.find(e=>e.old_hostname===t)),o||(o=datacenterDB?.find(e=>e.sales_hostname===t)),o&&console.log("[SAP Pro Toolkit] MATCH FOUND in DC entry:",o),console.log("[SAP Pro Toolkit] DC Entry found:",o?"YES":"NO",o),pageData={...currentEnvironment,companyId:n.companyId,baseUrl:n.baseUrl,hostname:t,userId:n.userInfo?.id,userName:n.userInfo?.fullName,personId:n.userInfo?.personId,personIdExternal:n.userInfo?.personIdExternal,assignmentId:n.userInfo?.assignmentId,assignmentIdExternal:n.userInfo?.assignmentIdExternal,assignmentUUID:n.userInfo?.assignmentUUID,proxyId:n.userInfo?.proxyId||null,detectedVia:"pageHeaderJsonData"},o&&(pageData={...pageData,environment:o.environment.toLowerCase(),datacenter:o.datacenter,country:o.country,platform:o.platform,region:o.region,apiHostname:o.api_hostname}),currentEnvironment=pageData,console.log("[SAP Pro Toolkit] Final page data:",pageData)}"sf-pro-toolkit-error"===e.data.type&&console.log("[SAP Pro Toolkit] Could not find pageHeaderJsonData, using URL-based detection")}})}function detectEnvironmentFromURL(e){const n=new URL(e).hostname;let t=datacenterDB?.find(e=>e.csd_hostname===n);if(t||(t=datacenterDB?.find(e=>e.old_hostname===n)),t||(t=datacenterDB?.find(e=>e.sales_hostname===n)),t)return{environment:t.environment.toLowerCase(),datacenter:t.datacenter,hostname:n,country:t.country,platform:t.platform,region:t.region,apiHostname:t.api_hostname,detectedVia:"hostname-lookup"};const o=detectEnvironmentHeuristic(n);const a=n.match(/hcm-(\w+\d+)/);if(a){const e=datacenterDB.find(e=>e.csd_hostname&&e.csd_hostname.includes(a[1]));if(e)return{environment:o,datacenter:e.datacenter,hostname:n,country:e.country,platform:e.platform,region:e.region,apiHostname:e.api_hostname||"Unknown",detectedVia:"heuristic-with-dc-match"}}return{environment:o,datacenter:"Unknown",hostname:n,country:"Unknown",platform:"Unknown",region:"Unknown",apiHostname:"Unknown",detectedVia:"heuristic"}}function detectEnvironmentHeuristic(e){if(e.includes("-preview")||e.includes("preview-")||e.includes("preview."))return"preview";const n=e.toLowerCase();return n.startsWith("demo.")||n.startsWith("sales.")||n.includes("-demo")||n.includes("-sales")?"sales":e.includes("sandbox")||e.includes("-test")||e.includes("test-")?"sandbox":"production"}!async function(){try{await loadDatacenterDB(),injectHelperScript(),setupMessageListeners();const e=detectEnvironmentFromURL(window.location.href);currentEnvironment=e,listenForPageData()}catch(e){console.error("[SAP Pro Toolkit] Initialization error:",e)}}(),console.log("[SAP Pro Toolkit] Content script loaded on:",window.location.hostname);
let currentPageData=null,shortcuts=[],environments=[],notes=[],solutions=[],settings={showConfirmationForProd:!0},availableProfiles=[],currentProfile="profile-default",popularOssNotes=null;async function loadSettings(){const t=await chrome.storage.sync.get({showConfirmationForProd:!0});settings=t}async function loadShortcuts(){if("profile-all"===currentProfile){let t=[];for(const e of availableProfiles)if(e.file&&"profile-all"!==e.id){const n=await loadProfileData(e.id),o=n.globalShortcuts||n.shortcuts||[];t.push(...o.map(t=>({...t,_source:e.name})))}return shortcuts=removeDuplicates(t,"url"),void renderShortcuts()}const t=await loadProfileData(currentProfile);shortcuts=t.globalShortcuts||t.shortcuts||[],await chrome.storage.local.set({shortcuts:shortcuts}),renderShortcuts()}async function loadEnvironments(){if("profile-all"===currentProfile){let t=[];for(const e of availableProfiles)if(e.file){const n=`environments_${e.id}`,o=await chrome.storage.local.get(n);o[n]&&Array.isArray(o[n])&&t.push(...o[n].map(t=>({...t,_source:e.name})))}return environments=removeDuplicates(t,"hostname"),void renderEnvironments()}const t=`environments_${currentProfile}`,e=await chrome.storage.local.get(t);if(e[t]&&Array.isArray(e[t])&&e[t].length>0)environments=e[t];else try{const e=await loadProfileData(currentProfile);e.environments&&Array.isArray(e.environments)?(environments=e.environments,await chrome.storage.local.set({[t]:environments})):environments=[]}catch(t){console.error("[Environments] Failed to load default environments:",t),environments=[]}renderEnvironments()}async function loadNotes(){const t=await chrome.storage.local.get(["notes","notesInitialized"]);if(notes=t.notes||[],!t.notesInitialized||0===notes.length)try{const t=await fetch(chrome.runtime.getURL("resources/profile-global.json")),e=await t.json();e.notes&&Array.isArray(e.notes)&&e.notes.length>0&&(notes=[...e.notes,...notes],await chrome.storage.local.set({notes:notes,notesInitialized:!0}))}catch(t){console.error("[Notes] Failed to load template notes from profile-global.json:",t)}console.log("[Notes] Loaded notes from storage:",notes.length,"notes"),console.log("[Notes] Notes data:",JSON.stringify(notes,null,2)),renderNotes()}async function loadCurrentPageData(){try{const[t]=await chrome.tabs.query({active:!0,lastFocusedWindow:!0});if(!t||!t.url)return currentPageData=null,renderEnvironments(),void updateDiagnosticsButton();const e=new URL(t.url).hostname,n=detectSolutionType(t.url,e);if(!n)return currentPageData=null,renderEnvironments(),void updateDiagnosticsButton();const o=new Promise(e=>{chrome.tabs.sendMessage(t.id,{action:"getPageData"},t=>{chrome.runtime.lastError?(console.log("[SF Pro Toolkit] Content script message failed, using URL detection"),e(null)):e(t)})}),a=new Promise(t=>setTimeout(()=>t(null),500)),s=await Promise.race([o,a]);s&&s.hostname?(currentPageData=s,currentPageData.url=t.url,currentPageData.solutionType=n,console.log("[SF Pro Toolkit] Using enhanced data from content script:",currentPageData)):(currentPageData=detectEnvironmentFromURL(t.url),currentPageData.url=t.url,currentPageData.solutionType=n,console.log("[SF Pro Toolkit] Using URL-based detection:",currentPageData)),await suggestProfileSwitch(n),renderEnvironments(),highlightActiveStates(t.url),updateDiagnosticsButton()}catch(t){console.error("[SF Pro Toolkit] Failed to load page data:",t),currentPageData=null,renderEnvironments(),updateDiagnosticsButton()}}async function suggestProfileSwitch(t){if(!t)return;const e={successfactors:"profile-successfactors",s4hana:"profile-s4hana",btp:"profile-btp",ibp:"profile-successfactors"}[t];if(!e)return;if(currentProfile===e||"profile-all"===currentProfile)return;const n=`profileSuggested_${t}`;if((await chrome.storage.session.get(n))[n])return;await chrome.storage.session.set({[n]:!0});const o=availableProfiles.find(t=>t.id===e);if(!o)return;const a={successfactors:"SuccessFactors",s4hana:"S/4HANA",btp:"BTP",ibp:"IBP"}[t]||t,s=chrome.i18n.getMessage("profileSwitchSuggestion").replace("{solutionLabel}",a).replace("{profileName}",o.name);showToast(s,"info",5e3,()=>{switchProfile(e)})}function updateDiagnosticsButton(){const t=document.getElementById("footerDiagnosticsBtn");if(!t)return;currentPageData&&currentPageData.solutionType?(t.classList.remove("btn-disabled"),t.setAttribute("title","Diagnostics")):(t.classList.add("btn-disabled"),t.setAttribute("title","Navigate to an SAP system to view diagnostics"))}async function loadProfileData(t){if("profile-all"===t)return{globalShortcuts:[],solutions:[],environments:[]};try{const e=await fetch(chrome.runtime.getURL("resources/profile-global.json")),n=await e.json();if("profile-global"===t)return n;const o=availableProfiles.find(e=>e.id===t);if(!o||!o.file)return n;const a=await fetch(chrome.runtime.getURL(`resources/${o.file}`)),s=await a.json();return{globalShortcuts:[...n.globalShortcuts||[],...s.globalShortcuts||[]],solutions:s.solutions||n.solutions||[],environments:[...n.environments||[],...s.environments||[]]}}catch(t){return console.error("[Profile] Failed to load profile data:",t),{globalShortcuts:[],solutions:[],environments:[]}}}async function renderEnvironments(){const t=document.getElementById("environmentList"),e=document.getElementById("addEnvBtn");if(e){"profile-all"===currentProfile?(e.classList.add("btn-disabled"),e.setAttribute("title","Switch to a specific profile to add environments")):(e.classList.remove("btn-disabled"),e.setAttribute("title",e.getAttribute("data-title")||"Add Environment"))}let n="";if(currentPageData&&currentPageData.solutionType){const t=currentPageData.solutionType,e=`solutions_${currentProfile}`;let o=(await chrome.storage.local.get(e))[e];if(!o){o=(await loadProfileData(currentProfile)).solutions}const a=o?.find(e=>e.id===t);if(a&&a.quickActions&&a.quickActions.length>0){const e=a.quickActions.slice(0,5);n=`\n        <tr class="quick-actions-standalone-row">\n          <td colspan="2" style="padding: 0;">\n            <div class="quick-actions-standalone">\n              <div class="quick-actions-header">\n                <span class="quick-actions-title">âš¡ ${a.name||t.toUpperCase()} Quick Actions</span>\n              </div>\n              <div class="quick-action-badges">\n                ${e.map(t=>`\n                  <span class="quick-action-badge" data-action-id="${t.id}" data-action-path="${t.path}">\n                    <span class="quick-action-icon">âš¡</span>${t.name}\n                  </span>\n                `).join("")}\n              </div>\n            </div>\n          </td>\n        </tr>\n      `}}if(0===environments.length){if(t.innerHTML=n+'\n      <tr class="empty-row">\n        <td colspan="2">\n          <div class="empty-state">\n            <p data-i18n="noEnvironments">No saved environments</p>\n            <button class="btn btn-secondary btn-sm" id="addEnvBtnInline" data-i18n="addCurrentInstance">+ Add Current Instance</button>\n          </div>\n        </td>\n      </tr>\n    ',document.getElementById("addEnvBtnInline")?.addEventListener("click",openAddEnvironmentModal),n){const t=`solutions_${currentProfile}`;let e=(await chrome.storage.local.get(t))[t];if(!e){e=(await loadProfileData(currentProfile)).solutions}const n=e?.find(t=>t.id===currentPageData.solutionType);n&&n.quickActions&&attachQuickActionBadgeHandlers(n.quickActions.slice(0,5))}return}let o=null,a=null,s=null;currentPageData&&(o=currentPageData.hostname,a=currentPageData.solutionType,s=currentPageData.url);const i=[...environments].sort((t,e)=>{const n=o&&o===t.hostname,a=o&&o===e.hostname;return n?-1:a?1:0});let r=[],c="";if(currentPageData&&currentPageData.solutionType){const t=`solutions_${currentProfile}`;let e=(await chrome.storage.local.get(t))[t];if(!e){e=(await loadProfileData(currentProfile)).solutions}const n=e?.find(t=>t.id===currentPageData.solutionType);if(n&&n.quickActions&&n.quickActions.length>0){r=n.quickActions.slice(0,5);c=`\n        <tr class="quick-actions-standalone-row">\n          <td colspan="2" style="padding: 0;">\n            <div class="quick-actions-standalone">\n              <div class="quick-actions-header">\n                <span class="quick-actions-title">âš¡ ${n.name||currentPageData.solutionType.toUpperCase()} Quick Actions</span>\n              </div>\n              <div class="quick-action-badges">\n                ${r.map(t=>`\n                  <span class="quick-action-badge" data-action-id="${t.id}" data-action-path="${t.path}">\n                    <span class="quick-action-icon">âš¡</span>${t.name}\n                  </span>\n                `).join("")}\n              </div>\n            </div>\n          </td>\n        </tr>\n      `}}t.innerHTML=c+i.map(t=>{const e=o&&o===t.hostname,n=window.SAPIconLibrary?window.SAPIconLibrary.ENVIRONMENT_ICONS[t.type]:null;let a;if(n&&n.path){const t="dark"===document.body.getAttribute("data-theme")?n.colorDark:n.color;a=`<svg width="18" height="18" viewBox="${n.viewBox}" fill="${t}" xmlns="http://www.w3.org/2000/svg" aria-label="${n.label}">\n        <path d="${n.path}"/>\n      </svg>`}else{a=`<span class="emoji-fallback">${{production:"ðŸ”´",preview:"ðŸŸ¢",sales:"ðŸŸ ",sandbox:"ðŸŸ£"}[t.type]||"ðŸ”µ"}</span>`}let i="";if(currentPageData&&e){const t=[];if(currentPageData.datacenter&&"Unknown"!==currentPageData.datacenter&&t.push(currentPageData.datacenter),currentPageData.region&&"Unknown"!==currentPageData.region){const e=currentPageData.country&&COUNTRY_FLAGS[currentPageData.country]?COUNTRY_FLAGS[currentPageData.country]:"";t.push(`${e} ${currentPageData.region}`)}const e=extractAllUrlParameters(s||"",currentPageData);e.company&&t.push(`Company: ${e.company}`),i=t.join(" â€¢ ")}let r="";r=e&&i?`<div class="env-hostname">${i}</div>`:`<div class="env-hostname">${t.hostname}</div>`;let c="";t.notes&&(c=`<div class="env-notes">${t.notes}</div>`);const l="profile-all"===currentProfile,d=l?"btn-disabled":"",u=l?"Switch to a specific profile to edit":"Edit",m=l?"Switch to a specific profile to delete":"Delete";return`\n      <tr class="env-row ${t.type}-env ${e?"active-row active-env-card":""}" data-env-id="${t.id}">\n        <td class="env-name-cell">\n          <div class="env-name">\n            <span class="status-dot ${t.type} ${e?"active":""}">${a}</span>\n            ${t.name}\n          </div>\n          ${r}\n          ${c}\n        </td>\n        <td class="env-actions-cell">\n          <div class="table-actions">\n            ${e?"":`\n              <button class="icon-btn primary switch-btn" data-hostname="${t.hostname}" data-type="${t.type}" title="Switch to this environment">\n                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                  <polyline points="23 4 23 10 17 10"/>\n                  <polyline points="1 20 1 14 7 14"/>\n                  <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>\n                </svg>\n              </button>\n            `}\n            <button class="icon-btn edit-btn ${d}" data-id="${t.id}" title="${u}" tabindex="0">\n              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>\n                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>\n              </svg>\n            </button>\n            <button class="icon-btn danger delete-btn ${d}" data-id="${t.id}" title="${m}" tabindex="0">\n              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <polyline points="3 6 5 6 21 6"/>\n                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>\n              </svg>\n            </button>\n          </div>\n        </td>\n      </tr>\n    `}).join(""),attachEnvironmentListeners(),attachQuickActionBadgeHandlers(r),updateSectionCounts()}function attachQuickActionBadgeHandlers(t){document.querySelectorAll(".quick-action-badge").forEach(e=>{e.addEventListener("click",async n=>{n.stopPropagation();const o=e.getAttribute("data-action-id"),a=t.find(t=>t.id===o);if(a)try{const[t]=await chrome.tabs.query({active:!0,lastFocusedWindow:!0});if(!t)return;const e=buildQuickActionUrl(a,currentPageData,t.url);console.log("[Quick Action] Navigating to:",a.name),console.log("[Quick Action] Target URL:",e),await chrome.tabs.update(t.id,{url:e}),showToast(`Navigating to ${a.name}...`,"success")}catch(t){console.error("[Quick Action] Navigation failed:",t),showToast("Failed to navigate","error")}else showToast("Quick Action not found","error")})})}function attachEnvironmentListeners(){document.querySelectorAll(".switch-btn").forEach(t=>{t.addEventListener("click",()=>{switchEnvironment(t.getAttribute("data-hostname"),t.getAttribute("data-type"))})}),document.querySelectorAll(".edit-btn").forEach(t=>{t.addEventListener("click",e=>{e.stopPropagation();editEnvironment(t.getAttribute("data-id"))})}),document.querySelectorAll(".delete-btn").forEach(t=>{t.addEventListener("click",e=>{e.stopPropagation();deleteEnvironment(t.getAttribute("data-id"))})}),document.querySelectorAll(".env-name, .env-hostname").forEach(t=>{t.scrollWidth>t.clientWidth&&t.setAttribute("title",t.textContent)})}function renderShortcuts(){const t=document.getElementById("shortcutsList"),e=document.getElementById("addShortcutBtn");if(e){if("profile-all"===currentProfile)e.classList.add("btn-disabled"),e.setAttribute("title","Switch to a specific profile to add shortcuts");else{e.classList.remove("btn-disabled");const t=e.getAttribute("data-title")||"Add Shortcut";e.setAttribute("title",t)}}if(0===shortcuts.length)return t.innerHTML='\n      <tr class="empty-row">\n        <td colspan="3">\n          <div class="empty-state">\n            <p data-i18n="noShortcuts">No shortcuts</p>\n            <button class="btn btn-secondary btn-sm" id="addCurrentPageBtnEmpty" data-i18n="addCurrentPage">+ Add Current Page</button>\n          </div>\n        </td>\n      </tr>\n    ',void document.getElementById("addCurrentPageBtnEmpty")?.addEventListener("click",addCurrentPageAsShortcut);const n="profile-all"===currentProfile,o=n?"btn-disabled":"",a=n?"Switch to a specific profile to edit":"Edit",s=n?"Switch to a specific profile to delete":"Delete";t.innerHTML=shortcuts.map(t=>{const e=renderSAPIcon(t.icon,"shortcut",16),n=renderTagBadges(t.tags);return`\n      <tr class="shortcut-row" data-shortcut-id="${t.id}" data-url="${t.url}">\n        <td class="shortcut-icon-cell">\n          <span class="shortcut-icon">${e}</span>\n        </td>\n        <td class="shortcut-name-cell">\n          <div class="shortcut-name">\n            ${t.name}\n          </div>\n          ${t.notes?`<div class="shortcut-notes">${t.notes}</div>`:""}\n          ${n}\n        </td>\n        <td class="shortcut-actions-cell">\n          <div class="table-actions">\n            <button class="icon-btn primary go-btn" data-url="${t.url}" title="Open shortcut" tabindex="0">\n              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                <line x1="5" y1="12" x2="19" y2="12"/>\n                <polyline points="12 5 19 12 12 19"/>\n              </svg>\n            </button>\n            <button class="icon-btn edit-btn ${o}" data-id="${t.id}" title="${a}" tabindex="0">\n              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>\n                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>\n              </svg>\n            </button>\n            <button class="icon-btn danger delete-btn ${o}" data-id="${t.id}" title="${s}" tabindex="0">\n              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <polyline points="3 6 5 6 21 6"/>\n                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>\n              </svg>\n            </button>\n          </div>\n        </td>\n      </tr>\n    `}).join(""),attachShortcutListeners(),updateSectionCounts()}function attachShortcutListeners(){document.querySelectorAll(".go-btn").forEach(t=>{t.addEventListener("click",e=>{e.stopPropagation();const n=t.getAttribute("data-url"),o=buildShortcutUrl({url:n},currentPageData);o?navigateToShortcut(o):showToast("Cannot navigate: No active SF instance detected","warning")})}),document.querySelectorAll(".shortcut-row .edit-btn").forEach(t=>{t.addEventListener("click",e=>{e.stopPropagation();editShortcut(t.getAttribute("data-id"))})}),document.querySelectorAll(".delete-btn").forEach(t=>{t.addEventListener("click",e=>{e.stopPropagation();deleteShortcut(t.getAttribute("data-id"))})}),document.querySelectorAll(".shortcut-name, .shortcut-notes").forEach(t=>{t.scrollWidth>t.clientWidth&&t.setAttribute("title",t.textContent)})}function renderNotes(){const t=document.getElementById("notesList");if(!t)return void console.error("[Notes] notesList tbody element not found!");const e=document.getElementById("addNoteBtn");if(e){if("profile-all"===currentProfile)e.classList.add("btn-disabled"),e.setAttribute("title","Switch to a specific profile to add notes");else{e.classList.remove("btn-disabled");const t=e.getAttribute("data-title")||"Add Note";e.setAttribute("title",t)}}if(0===notes.length)return t.innerHTML='\n      <tr class="empty-row">\n        <td colspan="3">\n          <div class="empty-state">\n            <p data-i18n="noNotes">No notes</p>\n            <button class="btn btn-secondary btn-sm" id="addNoteBtnEmpty" data-i18n="addNote">+ Add Note</button>\n          </div>\n        </td>\n      </tr>\n    ',void document.getElementById("addNoteBtnEmpty")?.addEventListener("click",openAddNoteModal);const n="profile-all"===currentProfile,o=n?"btn-disabled":"",a=n?"Switch to a specific profile to copy":"Copy note content",s=n?"Switch to a specific profile to delete":"Delete";t.innerHTML=notes.map(t=>{const e=t.content?t.content.length>60?t.content.substring(0,60)+"...":t.content:"",i=renderSAPIcon(t.icon,"note",16),r=renderTagBadges(t.tags),c=n?`<button class="icon-btn primary view-btn" data-id="${t.id}" title="View note (read-only)" tabindex="0">\n          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>\n            <circle cx="12" cy="12" r="3"/>\n          </svg>\n        </button>`:`<button class="icon-btn primary edit-btn" data-id="${t.id}" title="Edit" tabindex="0">\n          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>\n            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>\n          </svg>\n        </button>`;return`\n      <tr class="note-row" data-note-id="${t.id}">\n        <td class="note-icon-cell">\n          <span class="note-icon">${i}</span>\n        </td>\n        <td class="note-content-cell">\n          <div class="note-title">${t.title}</div>\n          ${e?`<div class="note-preview">${e}</div>`:""}\n          ${r}\n        </td>\n        <td class="note-actions-cell">\n          <div class="table-actions">\n            ${c}\n            <button class="icon-btn copy-btn ${o}" data-id="${t.id}" title="${a}" tabindex="0">\n              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>\n                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>\n              </svg>\n            </button>\n            <button class="icon-btn danger delete-btn ${o}" data-id="${t.id}" title="${s}" tabindex="0">\n              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <polyline points="3 6 5 6 21 6"/>\n                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>\n              </svg>\n            </button>\n          </div>\n        </td>\n      </tr>\n    `}).join(""),attachNoteListeners(),updateSectionCounts()}function attachNoteListeners(){document.querySelectorAll(".note-row .copy-btn").forEach(t=>{t.addEventListener("click",async e=>{e.stopPropagation();const n=t.getAttribute("data-id");await copyNoteContent(n,t)})}),document.querySelectorAll(".note-row .edit-btn").forEach(t=>{t.addEventListener("click",e=>{e.stopPropagation();editNote(t.getAttribute("data-id"))})}),document.querySelectorAll(".note-row .view-btn").forEach(t=>{t.addEventListener("click",e=>{e.stopPropagation();viewNoteReadOnly(t.getAttribute("data-id"))})}),document.querySelectorAll(".delete-btn").forEach(t=>{t.addEventListener("click",e=>{e.stopPropagation();deleteNote(t.getAttribute("data-id"))})}),document.querySelectorAll(".note-title, .note-preview").forEach(t=>{t.scrollWidth>t.clientWidth&&t.setAttribute("title",t.textContent)})}function setupSearchFilter(){const t=document.getElementById("globalSearch"),e=document.getElementById("clearSearch");t.addEventListener("input",t=>{const n=t.target.value.trim();e.style.display=n?"flex":"none",filterContent(n)}),e.addEventListener("click",()=>{t.value="",e.style.display="none",filterContent(""),t.focus()})}function filterContent(t){const e=t.toLowerCase();document.querySelectorAll(".env-row").forEach(t=>{const n=t.querySelector(".env-name")?.textContent.toLowerCase()||"",o=t.querySelector(".env-hostname")?.textContent.toLowerCase()||"",a=n.includes(e)||o.includes(e);t.style.display=a?"":"none"}),document.querySelectorAll(".shortcut-row").forEach(t=>{const n=t.getAttribute("data-shortcut-id"),o=shortcuts.find(t=>t.id===n);if(o){const n=(o.name||"").toLowerCase(),a=(o.notes||"").toLowerCase(),s=o.tags?o.tags.map(t=>t.toLowerCase()).join(" "):"",i=n.includes(e)||a.includes(e)||s.includes(e);t.style.display=i?"":"none"}else t.style.display="none"}),document.querySelectorAll(".note-row").forEach(t=>{const n=t.getAttribute("data-note-id"),o=notes.find(t=>t.id===n);if(o){const n=(o.title||"").toLowerCase(),a=(o.content||"").toLowerCase(),s=o.tags?o.tags.map(t=>t.toLowerCase()).join(" "):"",i=n.includes(e)||a.includes(e)||s.includes(e);t.style.display=i?"":"none"}else t.style.display="none"})}function filterByTag(t){const e=document.getElementById("globalSearch"),n=document.getElementById("clearSearch");e.value=t,n.style.display="flex",filterContent(t);const o=t.charAt(0).toUpperCase()+t.slice(1);showToast(`Filtering by: ${o}`,"info")}function renderTagBadges(t){return t&&0!==t.length?`<div class="tag-badges">${t.map(t=>{const e=t.charAt(0).toUpperCase()+t.slice(1);return`<span class="tag-badge clickable-tag" data-tag="${t}" title="Click to filter by ${t}">${e}</span>`}).join("")}</div>`:""}function highlightActiveStates(t){document.querySelectorAll(".shortcut-row").forEach(e=>{const n=e.getAttribute("data-url"),o=t&&n&&t.includes(n);e.classList.toggle("active-row",o)})}async function navigateToShortcut(t){try{const[e]=await chrome.tabs.query({active:!0,lastFocusedWindow:!0});e&&e.id?await chrome.tabs.update(e.id,{url:t}):await chrome.tabs.create({url:t})}catch(t){console.error("Navigation error:",t),showToast("Failed to navigate","error")}}async function switchEnvironment(t,e){try{if("production"===e&&settings.showConfirmationForProd){if(!confirm("âš ï¸ You are about to switch to PRODUCTION.\n\nAre you sure?"))return}const[n]=await chrome.tabs.query({active:!0,lastFocusedWindow:!0});let o;if(n&&isSFPage(n.url)){const e=new URL(n.url);o=e.href.replace(e.hostname,t)}else o=`https://${t}/`;await chrome.tabs.update(n.id,{url:o}),showToast(`Switching to ${t}...`,"success")}catch(t){console.error("Environment switch error:",t),showToast("Failed to switch environment","error")}}function openAddEnvironmentModal(){if("profile-all"===currentProfile)return void showToast("Switch to a specific profile to add environments","warning");const t=document.getElementById("addEnvModal");if(currentPageData){document.getElementById("envHostname").value=currentPageData.hostname||"";const t=currentPageData.environment||"production";document.getElementById("envType").value=t;let e=ENV_LABELS[t];currentPageData.datacenter&&"Unknown"!==currentPageData.datacenter&&(e+=` ${currentPageData.datacenter}`),document.getElementById("envName").value=e.trim()}t.classList.add("active")}function closeAddEnvironmentModal(){const t=document.getElementById("addEnvModal");t.classList.remove("active"),t.removeAttribute("data-edit-id"),document.getElementById("addEnvForm").reset(),document.querySelector("#addEnvModal .modal-header h3").textContent="Add Environment"}function editEnvironment(t){const e=environments.find(e=>e.id===t);e&&(document.getElementById("envName").value=e.name,document.getElementById("envType").value=e.type,document.getElementById("envHostname").value=e.hostname,document.getElementById("envNotes").value=e.notes||"",document.getElementById("addEnvModal").setAttribute("data-edit-id",t),document.querySelector("#addEnvModal .modal-header h3").textContent="Edit Environment",openAddEnvironmentModal())}async function deleteEnvironment(t){if("profile-all"===currentProfile)return void showToast("Switch to a specific profile to delete environments","warning");const e=environments.find(e=>e.id===t);if(!e)return;const n=chrome.i18n.getMessage("confirmDeleteEnvironment").replace("{envName}",e.name);if(!confirm(n))return;environments=environments.filter(e=>e.id!==t);const o=`environments_${currentProfile}`;await chrome.storage.local.set({[o]:environments}),renderEnvironments(),showToast("Environment deleted","success")}async function saveEnvironment(){if("profile-all"===currentProfile)return void showToast("Switch to a specific profile to save environments","warning");const t=document.getElementById("envName").value.trim(),e=document.getElementById("envType").value;let n=document.getElementById("envHostname").value.trim();if(!t)return showToast("Environment name is required","warning"),void document.getElementById("envName").focus();if(!n)return showToast("Hostname is required","warning"),void document.getElementById("envHostname").focus();n=n.replace(/^https?:\/\//,"");let o=n.split("/")[0].split("?")[0].split("#")[0];if(/\s/.test(o))return showToast("Hostname cannot contain spaces","error"),void document.getElementById("envHostname").focus();if(!/^[a-zA-Z0-9.-]+$/.test(o))return showToast("Hostname contains invalid characters. Use only letters, numbers, dots, and hyphens","error"),void document.getElementById("envHostname").focus();if(!["hr.cloud.sap","sapsf.com","sapsf.cn","sapcloud.cn","successfactors.eu","sapsf.eu","successfactors.com","s4hana.ondemand.com","s4hana.cloud.sap","hana.ondemand.com","cfapps","build.cloud.sap","ibp.cloud.sap","scmibp.ondemand.com","ibplanning"].some(t=>o.includes(t)))return showToast("Must be a valid SAP hostname (SuccessFactors, S/4HANA, BTP, or IBP)","error"),void document.getElementById("envHostname").focus();document.getElementById("envHostname").value=n;const a=document.getElementById("envNotes").value.trim(),s=document.getElementById("addEnvModal"),i=s.getAttribute("data-edit-id");try{if(i)environments=environments.filter(t=>t.id!==i),environments.push({id:i,name:t,type:e,hostname:n,notes:a}),showToast("Environment updated âœ“","success"),s.removeAttribute("data-edit-id");else{const o={id:`env-${Date.now()}`,name:t,type:e,hostname:n,notes:a};environments.push(o),showToast("Environment saved âœ“","success")}const o=`environments_${currentProfile}`;await chrome.storage.local.set({[o]:environments}),renderEnvironments(),closeAddEnvironmentModal()}catch(t){console.error("Failed to save environment:",t),showToast("Failed to save environment. Please try again.","error")}}function openAddShortcutModal(){document.getElementById("addShortcutModal").classList.add("active")}function closeAddShortcutModal(){const t=document.getElementById("addShortcutModal");t.classList.remove("active"),t.removeAttribute("data-edit-id"),document.getElementById("addShortcutForm").reset(),document.querySelector("#addShortcutModal .modal-header h3").textContent="Add Shortcut"}function editShortcut(t){const e=shortcuts.find(e=>e.id===t);if(!e)return void showToast("Shortcut not found. Try reloading the extension.","error");const n=document.getElementById("shortcutName"),o=document.getElementById("shortcutPath"),a=document.getElementById("shortcutNotes"),s=document.getElementById("shortcutIcon"),i=document.getElementById("shortcutTags"),r=document.getElementById("addShortcutModal"),c=document.querySelector("#addShortcutModal .modal-header h3");n&&o&&r?(n.value=e.name,o.value=e.url,a.value=e.notes||"",s.value=e.icon||"8",i.value=e.tags?e.tags.join(", "):"",r.setAttribute("data-edit-id",t),c&&(c.textContent="Edit Shortcut"),openAddShortcutModal()):showToast("Error: Form elements not found","error")}async function deleteShortcut(t){if("profile-all"===currentProfile)return void showToast("Switch to a specific profile to delete shortcuts","warning");const e=shortcuts.find(e=>e.id===t);if(!e)return;const n=chrome.i18n.getMessage("confirmDeleteShortcut").replace("{shortcutName}",e.name);confirm(n)&&(shortcuts=shortcuts.filter(e=>e.id!==t),await chrome.storage.local.set({shortcuts:shortcuts}),renderShortcuts(),showToast("Shortcut deleted","success"))}async function saveShortcut(){if("profile-all"===currentProfile)return void showToast("Switch to a specific profile to save shortcuts","warning");const t=document.getElementById("shortcutName").value.trim(),e=document.getElementById("shortcutPath").value.trim(),n=document.getElementById("shortcutNotes").value.trim(),o=document.getElementById("shortcutIcon").value||"8",a=document.getElementById("shortcutTags").value.trim(),s=a?a.split(",").map(t=>t.trim()).filter(t=>t):[];if(!t||!e)return void showToast("Please fill in required fields","warning");if(!e.startsWith("http://")&&!e.startsWith("https://"))return showToast("URL must start with http:// or https:// (external links only)","warning"),void document.getElementById("shortcutPath").focus();const i=document.getElementById("addShortcutModal"),r=i.getAttribute("data-edit-id");if(r)shortcuts=shortcuts.filter(t=>t.id!==r),shortcuts.push({id:r,name:t,url:e,notes:n,icon:o,tags:s}),showToast("Shortcut updated âœ“","success"),i.removeAttribute("data-edit-id");else{const a={id:`shortcut-${Date.now()}`,name:t,url:e,notes:n,icon:o,tags:s};shortcuts.push(a),showToast("Shortcut saved âœ“","success")}await chrome.storage.local.set({shortcuts:shortcuts}),renderShortcuts(),closeAddShortcutModal()}async function addCurrentPageAsShortcut(){if("profile-all"===currentProfile)return void showToast("Switch to a specific profile to add shortcuts","warning");const[t]=await chrome.tabs.query({active:!0,lastFocusedWindow:!0});t&&t.url?(document.getElementById("shortcutName").value=t.title.substring(0,50),document.getElementById("shortcutPath").value=t.url,document.getElementById("shortcutIcon").value="8",openAddShortcutModal()):showToast("No active tab found","warning")}function openAddNoteModal(){if("profile-all"===currentProfile)return void showToast("Switch to a specific profile to add notes","warning");const t=document.getElementById("downloadNoteBtn");t&&(t.style.display="none"),document.getElementById("addNoteModal").classList.add("active")}function closeAddNoteModal(){const t=document.getElementById("addNoteModal");t.classList.remove("active"),t.removeAttribute("data-edit-id");"true"===t.getAttribute("data-readonly-mode")&&(document.getElementById("noteTitle").removeAttribute("readonly"),document.getElementById("noteContent").removeAttribute("readonly"),document.getElementById("noteIcon").removeAttribute("disabled"),document.getElementById("noteTags").removeAttribute("readonly"),document.getElementById("saveNoteBtn").style.display="inline-flex",document.getElementById("prettifyNoteBtn").style.display="inline-flex",t.removeAttribute("data-readonly-mode")),document.getElementById("addNoteForm").reset(),document.querySelector("#addNoteModal .modal-header h3").textContent="Scratch Note"}function editNote(t){const e=notes.find(e=>e.id===t);if(!e)return;document.getElementById("noteTitle").value=e.title,document.getElementById("noteContent").value=e.content||"",document.getElementById("noteIcon").value=e.icon||"0",document.getElementById("noteTags").value=e.tags?e.tags.join(", "):"",document.getElementById("addNoteModal").setAttribute("data-edit-id",t),document.querySelector("#addNoteModal .modal-header h3").textContent="Edit Note",openAddNoteModal();const n=document.getElementById("downloadNoteBtn");n&&(n.style.display="inline-flex")}function viewNoteReadOnly(t){const e=notes.find(e=>e.id===t);e?(document.getElementById("noteTitle").value=e.title,document.getElementById("noteContent").value=e.content||"",document.getElementById("noteIcon").value=e.icon||"0",document.getElementById("noteTags").value=e.tags?e.tags.join(", "):"",document.querySelector("#addNoteModal .modal-header h3").textContent="View Note",document.getElementById("noteTitle").setAttribute("readonly",!0),document.getElementById("noteContent").setAttribute("readonly",!0),document.getElementById("noteIcon").setAttribute("disabled",!0),document.getElementById("noteTags").setAttribute("readonly",!0),document.getElementById("saveNoteBtn").style.display="none",document.getElementById("prettifyNoteBtn").style.display="none",document.getElementById("downloadNoteBtn").style.display="none",document.getElementById("addNoteModal").classList.add("active"),document.getElementById("addNoteModal").setAttribute("data-readonly-mode","true")):showToast("Note not found","error")}async function deleteNote(t){if("profile-all"===currentProfile)return void showToast("Switch to a specific profile to delete notes","warning");const e=notes.find(e=>e.id===t);if(!e)return;const n=chrome.i18n.getMessage("confirmDeleteNote").replace("{noteTitle}",e.title);confirm(n)&&(notes=notes.filter(e=>e.id!==t),await chrome.storage.local.set({notes:notes}),renderNotes(),showToast("Note deleted","success"))}async function saveNote(){if("profile-all"===currentProfile)return void showToast("Switch to a specific profile to save notes","warning");const t=document.getElementById("noteTitle").value.trim(),e=document.getElementById("noteContent").value.trim(),n=document.getElementById("noteIcon").value||"0",o=document.getElementById("noteTags").value.trim(),a=o?o.split(",").map(t=>t.trim()).filter(t=>t):[];if(!t)return void showToast("Please enter a title","warning");const s=document.getElementById("addNoteModal"),i=s.getAttribute("data-edit-id");if(i)notes=notes.filter(t=>t.id!==i),notes.push({id:i,title:t,content:e,icon:n,tags:a,timestamp:Date.now()}),showToast("Note updated âœ“","success"),s.removeAttribute("data-edit-id");else{const o={id:`note-${Date.now()}`,title:t,content:e,icon:n,tags:a,timestamp:Date.now()};notes.push(o),showToast("Note saved âœ“","success")}await chrome.storage.local.set({notes:notes}),renderNotes(),closeAddNoteModal()}async function copyNoteContent(t,e){if("profile-all"===currentProfile)return void showToast("Switch to a specific profile to copy notes","warning");const n=notes.find(e=>e.id===t);if(!n)return;const o=n.content||n.title;try{await navigator.clipboard.writeText(o),e&&(e.classList.add("copy-success"),setTimeout(()=>e.classList.remove("copy-success"),2e3)),showToast("Note copied âœ“","success")}catch(t){console.error("Failed to copy note:",t),showToast("Failed to copy note","error")}}async function downloadNote(t){if("profile-all"===currentProfile)return void showToast("Switch to a specific profile to download notes","warning");const e=notes.find(e=>e.id===t);if(e)try{const t=`${e.title}\n${"=".repeat(e.title.length)}\n\n${e.content||""}`,n=new Blob([t],{type:"text/plain"}),o=URL.createObjectURL(n),a=e.title.replace(/[^a-z0-9]/gi,"-").replace(/-+/g,"-").replace(/^-|-$/g,"").toLowerCase().substring(0,50),s=`${a}-${(new Date).toISOString().split("T")[0]}.txt`,i=document.createElement("a");i.href=o,i.download=s,i.click(),URL.revokeObjectURL(o),showToast("Note downloaded âœ“","success")}catch(t){console.error("Failed to download note:",t),showToast("Failed to download note","error")}}function prettifyNote(){const t=document.getElementById("noteContent"),e=document.getElementById("noteContentCounter");if(!t)return void console.error("[Prettify] Content input not found");let n=t.value;if(n.trim())try{n=n.replace(/\r\n/g,"\n").replace(/\r/g,"\n"),n=n.replace(/\n{3,}/g,"\n\n"),n=n.split("\n").map(t=>{const e=t.trim();return e.endsWith(":")&&e.length<50&&!e.startsWith("http")?e+"\n":t}).join("\n"),n=n.replace(/^[\s]*[-*â€¢]\s*/gm,"â€¢ ");const o=new Set;if(n.split("\n").forEach(t=>{const e=t.trim();/^https?:\/\/[^\s]+$/.test(e)&&o.add(e)}),n=n.replace(/(https?:\/\/[^\s]+)/g,(t,e)=>o.has(e)?e:`\n${e}\n`),n=n.replace(/^[\s]*(\d+)[.)]\s*/gm,"$1. "),n=n.replace(/\n{2,}(â€¢|\d+\.)/g,"\n\n$1"),n=n.split("\n").map(t=>t.trimEnd()).join("\n"),n=n.trim(),t.value=n,e){const t=n.length;t>=5e3?(e.classList.add("char-warning"),e.textContent=`${t.toLocaleString()} (âš ï¸ Large note)`):(e.classList.remove("char-warning"),e.textContent=t.toLocaleString())}showToast("Note formatted âœ“","success")}catch(t){console.error("[Prettify] Error:",t),showToast(`Format failed: ${t.message}`,"error")}else showToast("No content to format","warning")}function setupNoteCharacterCounter(){const t=document.getElementById("noteContent"),e=document.getElementById("noteContentCounter");if(!t||!e)return;function n(){const n=t.value.length;e.textContent=n.toLocaleString(),n>=5e3?(e.classList.add("char-warning"),e.textContent=`${n.toLocaleString()} (âš ï¸ Large note)`):(e.classList.remove("char-warning"),e.textContent=n.toLocaleString())}t.addEventListener("input",n);const o=document.getElementById("addNoteModal");new MutationObserver(t=>{t.forEach(t=>{"attributes"===t.type&&"class"===t.attributeName&&o.classList.contains("active")&&n()})}).observe(o,{attributes:!0})}async function showDiagnosticsModal(){if(!currentPageData||!currentPageData.solutionType)return void showToast("Navigate to an SAP system to view diagnostics","warning");const t=document.getElementById("diagnosticsModal"),e=document.getElementById("diagnosticsContent");t.classList.add("active"),e.innerHTML='\n    <div class="diagnostics-loading">\n      <div class="spinner"></div>\n      <span>Gathering diagnostics...</span>\n    </div>\n  ';try{await loadCurrentPageData();const t=await gatherDiagnostics(currentPageData),n=formatDiagnosticsReport(t);e.innerHTML=`<pre style="margin: 0; white-space: pre-wrap; word-wrap: break-word;">${n}</pre>`}catch(t){console.error("Failed to gather diagnostics:",t),e.innerHTML='<p style="color: var(--env-production);">Failed to gather diagnostics. Please try again.</p>'}}function closeDiagnosticsModal(){document.getElementById("diagnosticsModal").classList.remove("active")}async function copyAllDiagnostics(){try{await loadCurrentPageData();const t=await gatherDiagnostics(currentPageData),e=formatDiagnosticsReport(t);await navigator.clipboard.writeText(e),showToast("Diagnostics copied to clipboard âœ“","success")}catch(t){console.error("Failed to copy diagnostics:",t),showToast("Failed to copy diagnostics","error")}}async function loadPopularOssNotes(){if(popularOssNotes)return popularOssNotes;try{const t=await fetch(chrome.runtime.getURL("resources/popular-oss-notes.json"));return popularOssNotes=await t.json(),popularOssNotes}catch(t){return console.error("[Popular OSS Notes] Failed to load:",t),null}}async function getPopularNotesForProfile(){const t=await loadPopularOssNotes();if(!t)return[];if("profile-all"===currentProfile){const e=[...t.successfactors?.slice(0,2)||[],...t.s4hana?.slice(0,2)||[],...t.btp?.slice(0,2)||[]];return[...t.universal||[],...e]}return"profile-successfactors"===currentProfile?[...t.successfactors||[],...t.universal||[]]:"profile-s4hana"===currentProfile?[...t.s4hana||[],...t.universal||[]]:"profile-btp"===currentProfile?[...t.btp||[],...t.universal||[]]:t.universal||[]}async function renderPopularNotes(){const t=document.getElementById("popularNotesGrid");if(!t)return;const e=await getPopularNotesForProfile();0!==e.length?(t.innerHTML=e.map(t=>`\n    <button class="popular-note-btn" data-note-number="${t.number}" title="${t.description}">\n      <div class="popular-note-number">#${t.number}</div>\n      <div class="popular-note-title">${t.title}</div>\n    </button>\n  `).join(""),t.querySelectorAll(".popular-note-btn").forEach(t=>{t.addEventListener("click",async e=>{e.preventDefault();const n=t.getAttribute("data-note-number");await openPopularOssNote(n)})})):t.innerHTML='<div style="grid-column: 1/-1; text-align: center; padding: 12px; color: var(--text-secondary); font-size: 11px;">No popular notes available</div>'}async function openPopularOssNote(t){try{const e=`https://launchpad.support.sap.com/#/notes/${t}`;await chrome.tabs.create({url:e}),showToast(`Opening OSS Note ${t} âœ“`,"success")}catch(t){console.error("[Popular OSS Note] Failed to open:",t),showToast("Failed to open OSS Note","error")}}function togglePopularNotes(){const t=document.getElementById("popularNotesSection");if(!t)return;t.classList.toggle("collapsed");const e=t.classList.contains("collapsed");chrome.storage.local.set({popularNotesCollapsed:e})}async function toggleOssNoteSearch(){const t=document.getElementById("ossNoteSearchForm"),e=document.getElementById("ossNoteInputInline");if(!t)return;if("none"!==t.style.display)t.style.display="none";else{t.style.display="block",await renderPopularNotes();const n=await chrome.storage.local.get({popularNotesCollapsed:!1}),o=document.getElementById("popularNotesSection");o&&n.popularNotesCollapsed&&o.classList.add("collapsed"),e&&e.focus()}}function getValidatedOssNoteNumber(){const t=document.getElementById("ossNoteInputInline");if(!t)return null;let e=t.value.trim();return e=e.replace(/\D/g,""),e?e.length<4?(showToast("OSS Note number too short (minimum 4 digits)","warning"),t.focus(),null):e.length>10?(showToast("OSS Note number too long (maximum 10 digits)","warning"),t.focus(),null):e:(showToast("Please enter an OSS Note number","warning"),t.focus(),null)}async function openOssNoteInline(){const t=getValidatedOssNoteNumber();if(t)try{const e=`https://launchpad.support.sap.com/#/notes/${t}`;await chrome.tabs.create({url:e}),showToast(`Opening OSS Note ${t} âœ“`,"success"),document.getElementById("ossNoteInputInline").value=""}catch(t){console.error("[OSS Note] Failed to open:",t),showToast("Failed to open OSS Note","error")}}async function copyOssNoteUrl(){const t=getValidatedOssNoteNumber();if(t)try{const e=`https://launchpad.support.sap.com/#/notes/${t}`;await navigator.clipboard.writeText(e),showToast(chrome.i18n.getMessage("ossNoteCopied"),"success")}catch(t){console.error("[OSS Note] Failed to copy URL:",t),showToast("Failed to copy URL","error")}}async function addOssNoteAsShortcut(){const t=getValidatedOssNoteNumber();if(t)if("profile-all"!==currentProfile)try{const e=`https://launchpad.support.sap.com/#/notes/${t}`;document.getElementById("shortcutName").value=`OSS Note ${t}`,document.getElementById("shortcutPath").value=e,document.getElementById("shortcutNotes").value="SAP Support Launchpad",document.getElementById("shortcutIcon").value="document",document.getElementById("shortcutTags").value="oss-note, support",document.getElementById("ossNoteSearchForm").style.display="none",openAddShortcutModal(),showToast("Shortcut form pre-filled - review and save","success")}catch(t){console.error("[OSS Note] Failed to create shortcut:",t),showToast("Failed to create shortcut","error")}else showToast("Switch to a specific profile to add shortcuts","warning")}function openSettingsModal(){document.getElementById("settingsModal").classList.add("active")}function closeSettingsModal(){document.getElementById("settingsModal").classList.remove("active")}async function importJsonFromFile(){document.getElementById("importFileInput").click()}async function handleFileImport(t){const e=t.target.files[0];if(e){try{const n=await e.text();let o;try{o=JSON.parse(n)}catch(e){return console.error("JSON parse error:",e),showToast("Invalid JSON file. Please check file format.","error"),void(t.target.value="")}if(!o.shortcuts&&!o.environments&&!o.notes)return showToast("Invalid file structure. Expected shortcuts, environments, or notes.","error"),void(t.target.value="");if("custom"===o.profileType&&o.profileName){const e=`custom-${o.profileName.toLowerCase().replace(/\s+/g,"-")}`;if(availableProfiles.some(t=>t.id===e)){if(!confirm(`Profile "${o.profileName}" already exists.\n\nSwitch to this profile and import data?`))return void(t.target.value="");await switchProfile(e)}else{if(confirm(`ðŸ“¦ Create New Profile?\n\nProfile Name: ${o.profileName}\nItems: ${o.shortcuts?.length||0} shortcuts, ${o.environments?.length||0} environments, ${o.notes?.length||0} notes\n\nOptions:\nâ€¢ OK = Create new profile and switch to it\nâ€¢ Cancel = Import into current profile (${availableProfiles.find(t=>t.id===currentProfile)?.name})`))return await createCustomProfile(e,o.profileName,o),void(t.target.value="")}}const a=[];let s=0;if(o.shortcuts&&Array.isArray(o.shortcuts)){const t=o.shortcuts.filter(t=>!shortcuts.some(e=>e.url===t.url));shortcuts=[...t,...shortcuts],await chrome.storage.local.set({shortcuts:shortcuts}),s+=t.length,t.length>0&&a.push(`${t.length} shortcuts`)}if(o.environments&&Array.isArray(o.environments)){const t=o.environments.filter(t=>!environments.some(e=>e.hostname===t.hostname));environments=[...t,...environments];const e=`environments_${currentProfile}`;await chrome.storage.local.set({[e]:environments}),s+=t.length,t.length>0&&a.push(`${t.length} environments`)}if(o.notes&&Array.isArray(o.notes)){const t=o.notes.filter(t=>!notes.some(e=>e.title===t.title));notes=[...t,...notes],await chrome.storage.local.set({notes:notes}),s+=t.length,t.length>0&&a.push(`${t.length} notes`)}if(o.solutions&&Array.isArray(o.solutions)){const t=`solutions_${currentProfile}`;await chrome.storage.local.set({[t]:o.solutions}),solutions=o.solutions;const e=o.solutions.reduce((t,e)=>t+(e.quickActions?.length||0),0);e>0&&a.push(`${e} Quick Actions`)}if(renderNotes(),0===s)showToast("No new items to import (all items already exist)","warning");else{const t=a.join(", "),e=availableProfiles.find(t=>t.id===currentProfile);showToast(`Imported ${t} into ${e?.name||"current profile"} âœ“`,"success")}}catch(t){console.error("Import failed:",t),showToast(`Import failed: ${t.message}`,"error")}t.target.value=""}}async function createCustomProfile(t,e,n){try{const o=(await chrome.storage.local.get("customProfiles")).customProfiles||{};o[t]={id:t,name:e,type:"custom",basedOn:n.basedOn||"profile-global",created:(new Date).toISOString(),shortcuts:n.shortcuts||[],environments:n.environments||[],notes:n.notes||[]},await chrome.storage.local.set({customProfiles:o}),await chrome.storage.local.set({shortcuts:n.shortcuts||[],[`environments_${t}`]:n.environments||[],notes:n.notes||[]}),availableProfiles.push({id:t,name:e,type:"custom",file:null}),await switchProfile(t),showToast(`Created profile "${e}" âœ“`,"success")}catch(t){console.error("Failed to create custom profile:",t),showToast("Failed to create profile","error")}}async function exportJsonToFile(){try{const t=availableProfiles.find(t=>t.id===currentProfile),e=t?t.name.toLowerCase().replace(/\s+/g,"-"):"data",n=`solutions_${currentProfile}`,o=await chrome.storage.local.get(n);let a=o[n];if(!a){a=(await loadProfileData(currentProfile)).solutions||[]}const s={version:"1.0",profileType:"custom",profile:currentProfile,profileName:t?t.name:"Unknown",basedOn:currentProfile.startsWith("custom-")?"profile-successfactors":currentProfile,shortcuts:shortcuts,environments:environments,notes:notes,solutions:a,exportDate:(new Date).toISOString(),description:'Custom profile export. To create a new profile, edit "profileName" field and re-import. The extension will create a new custom profile with your chosen name. You can also edit the "solutions" array to customize Quick Actions.'},i=JSON.stringify(s,null,2),r=new Blob([i],{type:"application/json"}),c=URL.createObjectURL(r),l=(new Date).toISOString().split("T")[0],d=document.createElement("a");d.href=c,d.download=`sap-pro-toolkit-${e}-${l}.json`,d.click(),URL.revokeObjectURL(c);const u=shortcuts.length+environments.length+notes.length,m=a?.reduce((t,e)=>t+(e.quickActions?.length||0),0)||0;showToast(`Exported ${u} items + ${m} Quick Actions âœ“ | Edit "solutions" array to customize Quick Actions`,"success")}catch(t){console.error("Export failed:",t),showToast("Failed to export configuration","error")}}async function downloadTemplate(){try{const t={version:"1.0",shortcuts:[],environments:[],notes:[],exportDate:(new Date).toISOString()},e=JSON.stringify(t,null,2),n=new Blob([e],{type:"application/json"}),o=URL.createObjectURL(n),a=document.createElement("a");a.href=o,a.download="sap-pro-toolkit-template.json",a.click(),URL.revokeObjectURL(o),showToast("Template downloaded âœ“","success")}catch(t){console.error("Template download failed:",t),showToast("Failed to download template","error")}}async function initializeCollapsibleSections(){await chrome.storage.local.set({sectionStates:{environments:!0,shortcuts:!0,notes:!0}}),document.querySelectorAll(".section").forEach(t=>{t.getAttribute("data-section")&&t.classList.remove("collapsed")}),document.querySelectorAll(".section-toggle-btn").forEach(t=>{t.addEventListener("click",async e=>{e.stopPropagation();const n=t.getAttribute("data-section");await toggleSection(n)})}),updateSectionCounts()}async function toggleSection(t){const e=document.querySelector(`.section[data-section="${t}"]`);if(!e)return;const n=!e.classList.contains("collapsed");e.classList.toggle("collapsed");const o=(await chrome.storage.local.get("sectionStates")).sectionStates||{};o[t]=n,await chrome.storage.local.set({sectionStates:o})}function updateSectionCounts(){const t=document.querySelector('.section[data-section="environments"] .section-count');if(t){const e=environments.length;t.textContent=e>0?`(${e})`:""}const e=document.querySelector('.section[data-section="shortcuts"] .section-count');if(e){const t=shortcuts.length;e.textContent=t>0?`(${t})`:""}const n=document.querySelector('.section[data-section="notes"] .section-count');if(n){const t=notes.length;n.textContent=t>0?`(${t})`:""}}function setupEventListeners(){setupSearchFilter(),document.addEventListener("click",t=>{if(t.target.classList.contains("clickable-tag")){t.stopPropagation();filterByTag(t.target.getAttribute("data-tag"))}}),document.addEventListener("click",t=>{t.target.closest(".kebab-btn")||t.target.closest(".dropdown-menu")||document.querySelectorAll(".dropdown-menu").forEach(t=>t.classList.remove("active"))}),document.getElementById("helpBtn")?.addEventListener("click",()=>{document.getElementById("helpModal").classList.add("active")}),document.getElementById("closeHelpModal")?.addEventListener("click",()=>{document.getElementById("helpModal").classList.remove("active")}),document.getElementById("closeHelpBtn")?.addEventListener("click",()=>{document.getElementById("helpModal").classList.remove("active")}),document.getElementById("addEnvBtn")?.addEventListener("click",openAddEnvironmentModal),document.getElementById("closeAddEnvModal")?.addEventListener("click",closeAddEnvironmentModal),document.getElementById("cancelAddEnvBtn")?.addEventListener("click",closeAddEnvironmentModal),document.getElementById("saveEnvBtn")?.addEventListener("click",saveEnvironment),document.getElementById("addShortcutBtn")?.addEventListener("click",addCurrentPageAsShortcut),document.getElementById("closeAddShortcutModal")?.addEventListener("click",closeAddShortcutModal),document.getElementById("cancelAddShortcutBtn")?.addEventListener("click",closeAddShortcutModal),document.getElementById("saveShortcutBtn")?.addEventListener("click",saveShortcut),setupShortcutIconAutoSuggestion(),document.getElementById("addNoteBtn")?.addEventListener("click",openAddNoteModal),document.getElementById("closeAddNoteModal")?.addEventListener("click",closeAddNoteModal),document.getElementById("saveNoteBtn")?.addEventListener("click",saveNote),document.getElementById("prettifyNoteBtn")?.addEventListener("click",prettifyNote),document.getElementById("downloadNoteBtn")?.addEventListener("click",()=>{const t=document.getElementById("addNoteModal").getAttribute("data-edit-id");t&&downloadNote(t)}),setupNoteIconAutoSuggestion(),setupNoteCharacterCounter(),document.getElementById("copyDiagnosticsBtn")?.addEventListener("click",showDiagnosticsModal),document.getElementById("closeDiagnosticsModal")?.addEventListener("click",closeDiagnosticsModal),document.getElementById("closeDiagnosticsBtn")?.addEventListener("click",closeDiagnosticsModal),document.getElementById("copyAllDiagnosticsBtn")?.addEventListener("click",copyAllDiagnostics),document.getElementById("ossNoteBtn")?.addEventListener("click",async()=>{await toggleOssNoteSearch()}),document.getElementById("closeOssSearchBtn")?.addEventListener("click",()=>{document.getElementById("ossNoteSearchForm").style.display="none"}),document.getElementById("openOssNoteInlineBtn")?.addEventListener("click",openOssNoteInline),document.getElementById("copyOssUrlBtn")?.addEventListener("click",copyOssNoteUrl),document.getElementById("addOssShortcutBtn")?.addEventListener("click",addOssNoteAsShortcut),document.getElementById("ossNoteInputInline")?.addEventListener("keypress",t=>{"Enter"===t.key&&(t.preventDefault(),openOssNoteInline())}),document.getElementById("togglePopularNotes")?.addEventListener("click",togglePopularNotes),document.getElementById("settingsBtn")?.addEventListener("click",openSettingsModal),document.getElementById("closeSettingsModal")?.addEventListener("click",closeSettingsModal),document.getElementById("closeSettingsBtn")?.addEventListener("click",closeSettingsModal),document.getElementById("importJsonBtn")?.addEventListener("click",importJsonFromFile),document.getElementById("exportJsonBtn")?.addEventListener("click",exportJsonToFile),document.getElementById("downloadTemplateLink")?.addEventListener("click",t=>{t.preventDefault(),downloadTemplate()}),document.getElementById("importFileInput")?.addEventListener("change",handleFileImport),document.querySelectorAll(".modal").forEach(t=>{t.addEventListener("click",e=>{e.target===t&&t.classList.remove("active")})}),document.getElementById("footerSettingsBtn")?.addEventListener("click",openSettingsModal),document.getElementById("footerDiagnosticsBtn")?.addEventListener("click",showDiagnosticsModal),document.getElementById("footerThemeBtn")?.addEventListener("click",toggleTheme),document.getElementById("profileDropdownBtn")?.addEventListener("click",toggleProfileMenu),document.addEventListener("click",t=>{t.target.closest(".profile-switcher")||document.getElementById("profileMenu")?.classList.remove("active")})}async function loadTheme(){applyTheme((await chrome.storage.local.get({theme:"auto"})).theme)}function applyTheme(t){document.body.setAttribute("data-theme",t);const e=document.getElementById("footerThemeBtn");e&&e.setAttribute("data-theme-active","auto"!==t?"true":"false"),console.log("[Theme] Applied theme:",t)}async function toggleTheme(){let t,e=(await chrome.storage.local.get({theme:"auto"})).theme;t="auto"===e?"light":"light"===e?"dark":"auto",await chrome.storage.local.set({theme:t}),applyTheme(t);showToast(`Theme: ${{auto:"Auto",light:"Light",dark:"Dark"}[t]}`,"success")}async function discoverProfiles(){availableProfiles=[{id:"profile-all",name:"All Profiles",icon:"ðŸŒ",description:"View everything across all profiles",file:null,type:"system"},{id:"profile-global",name:"Global",icon:"âš¡",description:"Core SAP utilities for everyone",file:"profile-global.json",type:"system"},{id:"profile-successfactors",name:"SuccessFactors",icon:"ðŸ‘¥",description:"HR/HCM consultants & admins",file:"profile-successfactors.json",type:"system"},{id:"profile-s4hana",name:"S/4HANA",icon:"ðŸ­",description:"Clean Core & functional architects",file:"profile-s4hana.json",type:"system"},{id:"profile-btp",name:"BTP & Integration",icon:"ðŸ”§",description:"Developers & technical architects",file:"profile-btp.json",type:"system"},{id:"profile-executive",name:"Executive & Sales",icon:"ðŸ‘”",description:"CIOs, CTOs, presales engineers",file:"profile-executive.json",type:"system"},{id:"profile-golive",name:"Go-Live & Cutover",icon:"ðŸš€",description:"S/4HANA implementation go-live events and cutover activities",file:"profile-golive.json",type:"system"}];const t=(await chrome.storage.local.get("customProfiles")).customProfiles||{};for(const e in t){const n=t[e];availableProfiles.push({id:n.id,name:n.name,type:"custom",file:null})}renderProfileMenu()}async function loadActiveProfile(){const t=await chrome.storage.local.get({activeProfile:"profile-global"});currentProfile=t.activeProfile;const e=availableProfiles.find(t=>t.id===currentProfile);e&&(document.getElementById("currentProfileName").textContent=e.name),updateReadOnlyBanner()}function updateReadOnlyBanner(){const t=document.getElementById("readonlyBanner");if(!t)return;const e="profile-all"===currentProfile;t.style.display=e?"flex":"none"}function renderProfileMenu(){const t=document.getElementById("profileMenu");t&&(t.innerHTML=availableProfiles.map(t=>{const e=t.id===currentProfile,n=t.icon||"ðŸ“",o=t.description||"";return`\n      <button class="profile-menu-item ${e?"active":""}" data-profile-id="${t.id}">\n        <span class="profile-icon">${n}</span>\n        <div class="profile-info">\n          <div class="profile-name">${t.name}</div>\n          ${o?`<div class="profile-desc">${o}</div>`:""}\n        </div>\n        ${e?'<svg class="profile-check" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>':""}\n      </button>\n    `}).join(""),t.querySelectorAll(".profile-menu-item").forEach(t=>{t.addEventListener("click",e=>{e.stopPropagation();switchProfile(t.getAttribute("data-profile-id"))})}))}function toggleProfileMenu(){const t=document.getElementById("profileMenu");if(!t)return;const e=t.classList.contains("active");t.classList.toggle("active",!e)}async function switchProfile(t){if(t===currentProfile)return void document.getElementById("profileMenu")?.classList.remove("active");const e=availableProfiles.find(e=>e.id===t);if(e)try{await chrome.storage.local.set({activeProfile:t}),currentProfile=t,document.getElementById("currentProfileName").textContent=e.name,updateReadOnlyBanner(),await loadShortcuts(),await loadEnvironments(),await loadNotes(),renderProfileMenu(),document.getElementById("profileMenu")?.classList.remove("active"),showToast(`Switched to ${e.name}`,"success")}catch(t){console.error("Failed to switch profile:",t),showToast("Failed to switch profile","error")}else showToast("Profile not found","error")}function removeDuplicates(t,e){const n=new Set;return t.filter(t=>{const o=t[e];return!n.has(o)&&(n.add(o),!0)})}function setupShortcutIconAutoSuggestion(){const t=document.getElementById("shortcutName"),e=document.getElementById("shortcutNotes"),n=document.getElementById("shortcutTags"),o=document.getElementById("shortcutIcon"),a=document.getElementById("iconSuggestion"),s=document.getElementById("suggestedShortcutIconName"),i=document.getElementById("acceptShortcutSuggestion");if(!t||!o||!a)return;let r=null,c=null;function l(){c&&clearTimeout(c),c=setTimeout(()=>{!function(){const i=t.value.trim(),c=e?.value.trim()||"",l=n?.value.trim()||"";if(!i||void 0===window.SAPIconLibrary)return void(a.style.display="none");const d=window.SAPIconLibrary.suggestIcon(i,c,l,"shortcut");if(d&&d!==o.value){const t=window.SAPIconLibrary.getIconByValue(d,"shortcut");r=d,s.textContent=`${t.emoji} ${t.label}`,a.style.display="block"}else a.style.display="none"}()},500)}i&&i.addEventListener("click",()=>{r&&(o.value=r,a.style.display="none")}),t.addEventListener("input",l),e&&e.addEventListener("input",l),n&&n.addEventListener("input",l),o.addEventListener("change",()=>{a.style.display="none"})}window.debugNotes=async function(){const t=await chrome.storage.local.get("notes");console.log("=== NOTES DEBUG ==="),console.log("Notes in storage:",t.notes),console.log("Notes count:",t.notes?.length||0),console.log("Current notes variable:",notes),console.log("Notes count in memory:",notes.length);const e=await chrome.storage.local.get(null);return console.log("All storage keys:",Object.keys(e)),console.log('Keys containing "note":',Object.keys(e).filter(t=>t.toLowerCase().includes("note"))),{storage:t.notes,memory:notes,allKeys:Object.keys(e)}},document.addEventListener("DOMContentLoaded",async()=>{try{const t=await detectLanguage();await chrome.storage.local.set({detectedLanguage:t}),initI18n(),await loadTheme(),await discoverProfiles(),await loadActiveProfile(),await loadSettings(),await loadShortcuts(),await loadEnvironments(),await loadNotes(),await loadCurrentPageData(),setupEventListeners(),setupEnhancedKeyboardShortcuts({addShortcut:addCurrentPageAsShortcut,addNote:openAddNoteModal,filterContent:filterContent}),await initializeCollapsibleSections(),await initializeWorldClock(),await displayProfileUpdateDate(),updatePlatformSpecificUI(),chrome.tabs.onActivated.addListener(async()=>{await loadCurrentPageData()}),chrome.tabs.onUpdated.addListener(async(t,e,n)=>{"complete"===e.status&&await loadCurrentPageData()})}catch(t){console.error("Initialization error:",t),showToast("Failed to initialize extension","error")}});const DEFAULT_TIMEZONES=[{id:"america",name:"EST",timezone:"America/New_York",flag:"ðŸ‡ºðŸ‡¸"},{id:"europe",name:"CET",timezone:"Europe/Berlin",flag:"ðŸ‡©ðŸ‡ª"},{id:"asia",name:"IST",timezone:"Asia/Kolkata",flag:"ðŸ‡®ðŸ‡³"}];let worldClockInterval=null;async function initializeWorldClock(){try{const t=(await chrome.storage.local.get({worldClockTimezones:DEFAULT_TIMEZONES})).worldClockTimezones;updateWorldClock(t),worldClockInterval=setInterval(()=>{updateWorldClock(t)},6e4),window.addEventListener("beforeunload",()=>{worldClockInterval&&clearInterval(worldClockInterval)}),console.log("[World Clock] Initialized with timezones:",t.map(t=>t.name).join(", "))}catch(t){console.error("[World Clock] Initialization failed:",t)}}function updateWorldClock(t=DEFAULT_TIMEZONES){const e=document.getElementById("worldClock");if(e)try{const n=new Date,o=t.map(t=>{const e=n.toLocaleTimeString("en-US",{timeZone:t.timezone,hour:"numeric",minute:"2-digit",hour12:!0}),o=new Intl.DateTimeFormat("en-US",{timeZone:t.timezone,timeZoneName:"short"}).formatToParts(n),a=o.find(t=>"timeZoneName"===t.type)?.value||t.name;return`<span class="timezone-item" title="${t.timezone}">\n        <span class="timezone-flag">${t.flag}</span>\n        <span class="timezone-abbr">${a}</span>\n        <span class="timezone-time">${e}</span>\n      </span>`});e.innerHTML=o.join("")}catch(t){console.error("[World Clock] Update failed:",t),e.innerHTML='<span style="font-size: 9px; opacity: 0.5;">Clock error</span>'}}async function displayProfileUpdateDate(){const t=document.getElementById("profileUpdateDate");if(t)try{const e=await loadProfileData(currentProfile);if(e.lastUpdated){const n=new Date(e.lastUpdated),o=n.toLocaleDateString("en-US",{month:"short",day:"numeric"});t.textContent=`Profile: ${o}`,t.setAttribute("title",`Last updated: ${n.toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"})}`)}else e.contentVersion?(t.textContent=`Profile: ${e.contentVersion}`,t.setAttribute("title",`Content version: ${e.contentVersion}`)):t.textContent=""}catch(e){console.error("[Profile Date] Failed to load update date:",e),t.textContent=""}}function setupNoteIconAutoSuggestion(){const t=document.getElementById("noteTitle"),e=document.getElementById("noteContent"),n=document.getElementById("noteTags"),o=document.getElementById("noteIcon"),a=document.getElementById("noteIconSuggestion"),s=document.getElementById("suggestedNoteIconName"),i=document.getElementById("acceptNoteSuggestion");if(!t||!o||!a)return;let r=null,c=null;function l(){c&&clearTimeout(c),c=setTimeout(()=>{!function(){const i=t.value.trim(),c=e?.value.trim()||"",l=n?.value.trim()||"";if(!i||void 0===window.SAPIconLibrary)return void(a.style.display="none");const d=window.SAPIconLibrary.suggestIcon(i,c,l,"note");if(d&&d!==o.value){const t=window.SAPIconLibrary.getIconByValue(d,"note");r=d,s.textContent=`${t.emoji} ${t.label}`,a.style.display="block"}else a.style.display="none"}()},500)}i&&i.addEventListener("click",()=>{r&&(o.value=r,a.style.display="none")}),t.addEventListener("input",l),e&&e.addEventListener("input",l),n&&n.addEventListener("input",l),o.addEventListener("change",()=>{a.style.display="none"})}